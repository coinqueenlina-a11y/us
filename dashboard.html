<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>리나닷컴 대시보드 | 클라우드 제어판</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=JetBrains_Mono:wght@400;700&display=swap');

        :root {
            --bg-deep: #0f0a1e;
            --brand-primary: #a855f7;
            --text-main: #f5f3ff;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .bg-mesh {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 10% 10%, rgba(168, 85, 247, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 90%, rgba(139, 92, 246, 0.08) 0%, transparent 40%);
            z-index: -1;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
        }

        .admin-section {
            background: rgba(168, 85, 247, 0.05);
            border: 1px dashed rgba(168, 85, 247, 0.3);
            border-radius: 24px;
        }

        .sidebar-item.active {
            background: rgba(168, 85, 247, 0.15);
            border-left: 3px solid #a855f7;
            color: #d8b4fe;
        }

        .input-dark {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px 14px;
            color: white;
            font-size: 13px;
            outline: none;
            width: 100%;
            transition: all 0.2s;
        }

        .input-dark:focus {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .btn-save {
            background: #a855f7;
            color: white;
            font-weight: 700;
            padding: 12px;
            border-radius: 12px;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-save:hover { background: #9333ea; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4); }
        .btn-save:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #10b981;
            color: #fff;
            text-align: center;
            border-radius: 12px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            right: 30px;
            bottom: 30px;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .modal-content {
            background: #1a142e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
        }

        .loader {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body class="min-h-screen flex">
    <div class="bg-mesh"></div>
    <div id="toast">데이터가 클라우드에 동기화되었습니다.</div>

    <!-- 로고 선택 모달 -->
    <div id="asset-modal" class="modal-overlay" onclick="closeAssetModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white">로고 이미지 선택</h3>
                    <p class="text-[10px] text-white/40 mt-1">저장된 자산 또는 외부 URL을 사용하세요.</p>
                </div>
                <button onclick="document.getElementById('asset-modal').style.display='none'" class="text-white/40 hover:text-white transition-colors p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="asset-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                <div onclick="selectLogo('https://raw.githubusercontent.com/talmobottle1-boop/newtank26/main/assets/images/binance.png')" class="bg-white/5 border border-white/10 rounded-xl p-4 cursor-pointer hover:border-purple-500 hover:bg-white/10 transition-all flex flex-col items-center gap-3">
                    <img src="https://raw.githubusercontent.com/talmobottle1-boop/newtank26/main/assets/images/binance.png" class="h-10 object-contain">
                    <span class="text-[10px] text-white/50">Binance</span>
                </div>
                <div onclick="selectLogo('https://raw.githubusercontent.com/talmobottle1-boop/newtank26/main/assets/images/bitget.png')" class="bg-white/5 border border-white/10 rounded-xl p-4 cursor-pointer hover:border-purple-500 hover:bg-white/10 transition-all flex flex-col items-center gap-3">
                    <img src="https://raw.githubusercontent.com/talmobottle1-boop/newtank26/main/assets/images/bitget.png" class="h-10 object-contain">
                    <span class="text-[10px] text-white/50">Bitget</span>
                </div>
                <div onclick="selectLogo('https://cdn.worldvectorlogo.com/logos/bybit-logo.svg')" class="bg-white/5 border border-white/10 rounded-xl p-4 cursor-pointer hover:border-purple-500 hover:bg-white/10 transition-all flex flex-col items-center gap-3">
                    <img src="https://cdn.worldvectorlogo.com/logos/bybit-logo.svg" class="h-10 object-contain">
                    <span class="text-[10px] text-white/50">Bybit</span>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-white/10">
                <label class="text-[11px] text-white/50 mb-2 block font-bold">직접 URL 입력</label>
                <div class="flex gap-2">
                    <input type="text" id="custom-logo-url" class="input-dark" placeholder="https://example.com/logo.png">
                    <button onclick="selectLogo(document.getElementById('custom-logo-url').value)" class="bg-purple-500 px-4 rounded-xl text-xs font-bold">적용</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 사이드바 -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-[#0a0515]/90 border-r border-white/5 z-50 lg:static transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
        <div class="p-6">
            <div class="flex items-center space-x-2.5 mb-10">
                <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-purple-500 to-purple-800 flex items-center justify-center shadow-lg">
                    <i class="fas fa-infinity text-white text-xs"></i>
                </div>
                <span class="text-lg font-bold italic tracking-tighter text-white">리나<span class="text-purple-500">닷컴</span></span>
            </div>

            <nav class="space-y-1">
                <a href="#" class="sidebar-item active flex items-center space-x-3 px-4 py-3.5 rounded-xl text-sm font-medium transition-all">
                    <i class="fas fa-cloud-upload-alt w-5"></i>
                    <span>클라우드 제어판</span>
                </a>
            </nav>
        </div>
    </aside>

    <!-- 메인 콘텐츠 -->
    <main class="flex-1 flex flex-col min-w-0">
        <header class="h-16 border-b border-white/5 flex items-center justify-between px-6 lg:px-10 bg-[#0f0a1e]/50 backdrop-blur-md sticky top-0 z-40">
            <div class="flex items-center">
                <button onclick="toggleSidebar()" class="lg:hidden text-white mr-4"><i class="fas fa-bars"></i></button>
                <h1 class="text-sm font-bold text-white/80 uppercase tracking-widest">Lina Cloud Control</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="auth-status" class="text-[10px] bg-white/5 text-white/40 px-2 py-1 rounded font-bold border border-white/10 tracking-widest uppercase transition-all">연결 중...</span>
            </div>
        </header>

        <div class="p-6 lg:p-10 space-y-12 max-w-5xl mx-auto w-full">
            <!-- 전역 설정 섹션 -->
            <section class="admin-section p-8 space-y-8">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center shadow-[0_0_15px_rgba(168,85,247,0.5)]"><i class="fas fa-bullhorn text-white"></i></div>
                    <div>
                        <h2 class="text-xl font-bold">전역 설정</h2>
                        <p class="text-[10px] text-white/40">공지사항 및 상단 팝업 텍스트를 실시간으로 제어합니다.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h3 class="text-[10px] font-black text-purple-400 uppercase tracking-widest">텍스트 설정</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-[11px] text-white/50 mb-1 block">공지사항 제목</label>
                                <input type="text" id="notice-title" class="input-dark" placeholder="공지사항 제목">
                            </div>
                            <div>
                                <label class="text-[11px] text-white/50 mb-1 block">팝업 메인 텍스트</label>
                                <input type="text" id="top-popup-text" class="input-dark" placeholder="팝업 내용">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-[11px] text-white/50">거래소 버튼</label><input type="text" id="top-popup-exchange" class="input-dark" placeholder="거래소명"></div>
                                <div><label class="text-[11px] text-white/50">액션 버튼</label><input type="text" id="top-popup-action" class="input-dark" placeholder="버튼명"></div>
                            </div>
                            <div class="flex items-center space-x-2 pt-2">
                                <input type="checkbox" id="top-popup-hide" class="w-4 h-4 accent-purple-500">
                                <label for="top-popup-hide" class="text-xs text-red-400 font-bold">상단 배너 숨기기</label>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-[10px] font-black text-purple-400 uppercase tracking-widest">계산기 설정</h3>
                        <div class="space-y-3">
                            <label class="text-[11px] text-white/50">지원 거래소 (쉼표 구분)</label>
                            <textarea id="calc-exchanges" class="input-dark h-32" placeholder="Binance, Bitget, Bybit..."></textarea>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 거래소 관리 섹션 -->
            <section class="glass-card p-8 space-y-8">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold"><i class="fas fa-list mr-2 text-indigo-400"></i>제휴 거래소 관리</h2>
                    <button onclick="addExchangeRow()" class="px-4 py-2 bg-white/5 border border-white/10 rounded-xl text-xs font-bold hover:bg-white/10 transition-all">+ 추가</button>
                </div>
                <div id="exchange-list" class="space-y-6">
                    <!-- 거래소 리스트 렌더링 영역 -->
                </div>
            </section>

            <!-- 하단 고정 저장 버튼 -->
            <div class="sticky bottom-10">
                <button id="save-btn" onclick="saveToCloud()" class="btn-save w-full py-5 text-lg shadow-2xl" disabled>
                    <span id="save-loader" class="loader"></span>
                    <i id="save-icon" class="fas fa-cloud-upload-alt mr-2"></i>
                    <span id="save-text">데이터 동기화 준비 중...</span>
                </button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. 파이어베이스 초기 설정
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'linapay-web';

        // 전역 상태
        let localConfig = { 
            home: {
                noticeTitle: "",
                topText: "",
                topExchange: "",
                topAction: "",
                topHide: false,
                calcExchanges: ""
            }, 
            exchanges: [] 
        };
        let currentEditingIndex = -1;
        let currentUser = null;
        let unsubscribe = null;

        // 2. 인증 로직 (RULE 3 준수)
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("인증 실패:", err);
                document.getElementById('auth-status').innerText = "인증 오류";
                document.getElementById('auth-status').classList.add('text-red-500');
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const statusEl = document.getElementById('auth-status');
            const saveBtn = document.getElementById('save-btn');
            const saveText = document.getElementById('save-text');

            if (user) {
                statusEl.innerText = `온라인: ${user.uid.substring(0, 8)}`;
                statusEl.classList.remove('text-white/40', 'text-red-500');
                statusEl.classList.add('text-emerald-400');
                
                saveBtn.disabled = false;
                saveText.innerText = "데이터 실시간 클라우드 동기화";
                
                // Firestore 리스너 시작
                startListening();
            } else {
                statusEl.innerText = "오프라인";
                statusEl.classList.remove('text-emerald-400');
                statusEl.classList.add('text-white/40');
                saveBtn.disabled = true;
                saveText.innerText = "연결 필요";
            }
        });

        // 3. Firestore 리얼타임 리스너 (RULE 1 준수)
        function startListening() {
            if (!currentUser) return;
            
            // 기존 리스너 해제
            if (unsubscribe) unsubscribe();

            // 경로: /artifacts/{appId}/public/data/configs/global (정확히 6개 세그먼트)
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'configs', 'global');
            
            unsubscribe = onSnapshot(docRef, (snapshot) => {
                if (snapshot.exists()) {
                    localConfig = snapshot.data();
                    // 구조 보장
                    if (!localConfig.home) localConfig.home = {};
                    if (!localConfig.exchanges) localConfig.exchanges = [];
                    syncUI();
                } else {
                    console.log("클라우드에 데이터가 없습니다. 초기 설정을 준비합니다.");
                    syncUI(); 
                }
            }, (error) => {
                console.error("데이터 수신 오류:", error);
                // 지수 백오프 로직은 브라우저 환경에서 필요 시 추가 가능하나, 
                // onSnapshot은 내부적으로 재연결 로직이 포함되어 있습니다.
            });
        }

        // 4. UI 동기화
        function syncUI() {
            const h = localConfig.home || {};
            document.getElementById('notice-title').value = h.noticeTitle || "";
            document.getElementById('top-popup-text').value = h.topText || "";
            document.getElementById('top-popup-exchange').value = h.topExchange || "";
            document.getElementById('top-popup-action').value = h.topAction || "";
            document.getElementById('top-popup-hide').checked = h.topHide || false;
            document.getElementById('calc-exchanges').value = h.calcExchanges || "";
            renderExchanges();
        }

        // 5. 거래소 리스트 렌더링
        function renderExchanges() {
            const container = document.getElementById('exchange-list');
            container.innerHTML = '';
            const list = localConfig.exchanges || [];
            
            if (list.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-white/20 text-xs">등록된 거래소가 없습니다.</div>`;
                return;
            }

            list.forEach((ex, index) => {
                const div = document.createElement('div');
                div.className = "p-6 glass-card space-y-4 transition-all hover:border-purple-500/30";
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white/5 rounded-lg p-1.5 flex items-center justify-center">
                                <img src="${ex.logo || 'https://via.placeholder.com/50'}" class="max-w-full max-h-full object-contain">
                            </div>
                            <div class="flex flex-col">
                                <input type="text" class="bg-transparent border-none text-white font-bold outline-none focus:text-purple-400" value="${ex.name || ''}" placeholder="거래소명" onchange="window.updateEx(${index}, 'name', this.value)">
                                <span class="text-[9px] text-white/30 font-mono">${ex.id || 'NEW'}</span>
                            </div>
                        </div>
                        <button onclick="window.deleteEx(${index})" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-500/20 text-red-400 transition-colors"><i class="fas fa-trash-alt text-xs"></i></button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-white/40 mb-1 block">연결 링크</label>
                            <input type="text" class="input-dark text-xs" placeholder="URL" value="${ex.link || ''}" onchange="window.updateEx(${index}, 'link', this.value)">
                        </div>
                        <div>
                            <label class="text-[10px] text-white/40 mb-1 block">페이백 요율 (%)</label>
                            <input type="number" class="input-dark text-xs" placeholder="Rate" value="${ex.rate || 0}" onchange="window.updateEx(${index}, 'rate', parseInt(this.value))">
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="window.openAssetModal(${index})" class="text-[10px] font-bold text-purple-400 border border-purple-400/30 px-3 py-1.5 rounded-lg hover:bg-purple-500 hover:text-white transition-all">로고 이미지 변경</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 6. 데이터 조작 핸들러 (전역 할당)
        window.updateEx = (i, k, v) => { 
            if (localConfig.exchanges[i]) {
                localConfig.exchanges[i][k] = v; 
            }
        };

        window.deleteEx = (i) => { 
            if (confirm("해당 거래소 정보를 삭제하시겠습니까?")) {
                localConfig.exchanges.splice(i, 1); 
                renderExchanges(); 
            }
        };

        window.addExchangeRow = () => {
            if(!localConfig.exchanges) localConfig.exchanges = [];
            localConfig.exchanges.push({ 
                id: 'ex-' + Date.now(),
                name: '새 거래소', 
                logo: 'https://via.placeholder.com/50', 
                link: '', 
                rate: 0 
            });
            renderExchanges();
            // 스크롤 하단 이동
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        };

        window.openAssetModal = (i) => {
            currentEditingIndex = i;
            document.getElementById('asset-modal').style.display = 'flex';
        };

        window.selectLogo = (url) => {
            if (currentEditingIndex > -1 && localConfig.exchanges[currentEditingIndex]) {
                localConfig.exchanges[currentEditingIndex].logo = url;
                renderExchanges();
            }
            document.getElementById('asset-modal').style.display = 'none';
        };

        // 7. 클라우드 저장 (RULE 1 & 3 준수)
        window.saveToCloud = async () => {
            if (!currentUser) {
                alert("인증 세션이 만료되었습니다. 페이지를 새로고침해주세요.");
                return;
            }

            const btn = document.getElementById('save-btn');
            const loader = document.getElementById('save-loader');
            const icon = document.getElementById('save-icon');
            const saveText = document.getElementById('save-text');

            // 상태 업데이트
            btn.disabled = true;
            loader.style.display = 'inline-block';
            icon.style.display = 'none';
            saveText.innerText = "업로드 중...";

            // 입력값 취합
            localConfig.home = {
                noticeTitle: document.getElementById('notice-title').value.trim(),
                topText: document.getElementById('top-popup-text').value.trim(),
                topExchange: document.getElementById('top-popup-exchange').value.trim(),
                topAction: document.getElementById('top-popup-action').value.trim(),
                topHide: document.getElementById('top-popup-hide').checked,
                calcExchanges: document.getElementById('calc-exchanges').value.trim()
            };

            try {
                // 경로: /artifacts/{appId}/public/data/configs/global
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'configs', 'global');
                
                // 데이터 저장 시 무결성을 위해 전체 객체를 다시 씀
                await setDoc(docRef, {
                    ...localConfig,
                    lastUpdated: new Date().toISOString(),
                    updatedBy: currentUser.uid
                }, { merge: false });

                // 성공 토스트
                const toast = document.getElementById("toast");
                toast.className = "show";
                setTimeout(() => { toast.className = ""; }, 3000);
                
            } catch (err) {
                console.error("저장 실패:", err);
                alert("클라우드 동기화 실패: " + err.message);
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
                icon.style.display = 'inline-block';
                saveText.innerText = "데이터 실시간 클라우드 동기화";
            }
        };

        // 기타 UI 기능
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('-translate-x-full');
        window.closeAssetModal = (e) => { if(e.target.id === 'asset-modal') document.getElementById('asset-modal').style.display='none'; };

        // 실행 시작
        initAuth();
    </script>
</body>
</html>
