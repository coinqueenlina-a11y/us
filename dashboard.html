<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>리나닷컴 대시보드 | 파이어베이스 클라우드 제어판</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=JetBrains_Mono:wght@400;700&display=swap');
        :root { --bg-deep: #0f0a1e; --brand-primary: #a855f7; --text-main: #f5f3ff; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-deep); color: var(--text-main); }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; }
        .admin-section { background: rgba(168, 85, 247, 0.05); border: 1px dashed rgba(168, 85, 247, 0.3); border-radius: 24px; }
        .input-dark { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 10px 14px; color: white; outline: none; width: 100%; transition: all 0.2s; }
        .input-dark:focus { border-color: #a855f7; background: rgba(168, 85, 247, 0.1); }
        .btn-save { background: #a855f7; color: white; font-weight: 700; padding: 12px; border-radius: 12px; transition: all 0.2s; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-save:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4); }
        #toast { visibility: hidden; position: fixed; bottom: 30px; right: 30px; background: #10b981; color: white; padding: 16px 24px; border-radius: 12px; font-weight: bold; z-index: 1000; }
        #toast.show { visibility: visible; animation: fadeInUp 0.5s; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 2px solid rgba(255, 255, 255, 0.1); border-top: 2px solid #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 200; }
        .modal-content { background: #1a142e; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; width: 90%; max-width: 600px; padding: 30px; }
    </style>
</head>
<body class="min-h-screen flex">
    <div id="toast">성공적으로 클라우드에 동기화되었습니다.</div>

    <!-- 로고 선택 모달 -->
    <div id="asset-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-6">로고 이미지 선택</h3>
            <div class="grid grid-cols-3 gap-4">
                <div onclick="selectLogo('https://raw.githubusercontent.com/talmobottle1-boop/newtank26/main/assets/images/binance.png')" class="glass-card p-4 cursor-pointer hover:border-purple-500 flex flex-col items-center gap-2">
                    <img src="https://raw.githubusercontent.com/talmobottle1-boop/newtank26/main/assets/images/binance.png" class="h-8">
                    <span class="text-[10px] opacity-50">Binance</span>
                </div>
                <div onclick="selectLogo('https://raw.githubusercontent.com/talmobottle1-boop/newtank26/main/assets/images/bitget.png')" class="glass-card p-4 cursor-pointer hover:border-purple-500 flex flex-col items-center gap-2">
                    <img src="https://raw.githubusercontent.com/talmobottle1-boop/newtank26/main/assets/images/bitget.png" class="h-8">
                    <span class="text-[10px] opacity-50">Bitget</span>
                </div>
                <div onclick="selectLogo('https://cdn.worldvectorlogo.com/logos/bybit-logo.svg')" class="glass-card p-4 cursor-pointer hover:border-purple-500 flex flex-col items-center gap-2">
                    <img src="https://cdn.worldvectorlogo.com/logos/bybit-logo.svg" class="h-8">
                    <span class="text-[10px] opacity-50">Bybit</span>
                </div>
            </div>
            <button onclick="document.getElementById('asset-modal').style.display='none'" class="mt-8 w-full py-2 text-white/40">닫기</button>
        </div>
    </div>

    <!-- 사이드바 -->
    <aside class="w-64 border-r border-white/5 p-6 hidden lg:block">
        <div class="text-xl font-bold mb-10">리나<span class="text-purple-500">대시보드</span></div>
        <nav class="space-y-2">
            <div class="p-3 bg-purple-500/10 text-purple-400 rounded-xl flex items-center gap-3">
                <i class="fas fa-sync-alt"></i> 실시간 클라우드 연동
            </div>
        </nav>
    </aside>

    <!-- 메인 -->
    <main class="flex-1 p-6 lg:p-10 max-w-5xl mx-auto w-full space-y-10">
        <header class="flex justify-between items-center">
            <h1 class="text-2xl font-bold">홈페이지 통합 제어</h1>
            <span id="auth-status" class="text-[10px] opacity-40 uppercase tracking-widest">연결 대기</span>
        </header>

        <!-- 설정 섹션 -->
        <section class="admin-section p-8 space-y-6">
            <h2 class="font-bold flex items-center gap-2 text-purple-400"><i class="fas fa-desktop"></i> 메인 화면 문구 수정</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div><label class="text-xs opacity-50 mb-1 block">히어로 메인 제목</label><input type="text" id="notice-title" class="input-dark"></div>
                    <div><label class="text-xs opacity-50 mb-1 block">상단 팝업 공지</label><input type="text" id="top-popup-text" class="input-dark"></div>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs opacity-50 mb-1 block">상단 타겟 거래소</label><input type="text" id="top-popup-exchange" class="input-dark" placeholder="바이낸스"></div>
                        <div><label class="text-xs opacity-50 mb-1 block">팝업 버튼명</label><input type="text" id="top-popup-action" class="input-dark"></div>
                    </div>
                    <div class="flex items-center gap-4 py-2">
                         <div class="flex items-center gap-2"><input type="checkbox" id="top-popup-hide" class="w-5 h-5 accent-purple-500"><label class="text-xs text-red-400">배너 숨김</label></div>
                         <div class="flex-1"><label class="text-xs opacity-50 mb-1 block">지원 리스트</label><input type="text" id="calc-exchanges" class="input-dark text-xs" placeholder="Binance, Bitget..."></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 거래소 관리 -->
        <section class="glass-card p-8 space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="font-bold">제휴 거래소 리스트</h2>
                <button onclick="addExchangeRow()" class="text-xs bg-white/10 px-3 py-1 rounded-lg">+ 거래소 추가</button>
            </div>
            <div id="exchange-list" class="space-y-4"></div>
        </section>

        <!-- 저장 버튼 -->
        <div class="sticky bottom-10">
            <button id="save-btn" onclick="saveToFirebase()" class="btn-save w-full py-5 text-lg shadow-2xl" disabled>
                <span id="save-loader" class="loader"></span>
                <i class="fas fa-cloud-upload-alt mr-2"></i>
                <span id="save-text">클라우드 동기화 (홈페이지 즉시 반영)</span>
            </button>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'linapay-web';

        let localConfig = { home: {}, exchanges: [] };
        let currentEditingIndex = -1;

        const init = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-status').innerText = "Cloud Sync Active";
                document.getElementById('save-btn').disabled = false;
                startListening();
            }
        });

        // 실시간으로 Firestore에서 최신 상태 가져오기
        function startListening() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'configs', 'global');
            onSnapshot(docRef, (snapshot) => {
                if (snapshot.exists()) {
                    localConfig = snapshot.data();
                    syncUI();
                }
            });
        }

        function syncUI() {
            const h = localConfig.home || {};
            document.getElementById('notice-title').value = h.noticeTitle || "";
            document.getElementById('top-popup-text').value = h.topText || "";
            document.getElementById('top-popup-exchange').value = h.topExchange || "";
            document.getElementById('top-popup-action').value = h.topAction || "";
            document.getElementById('top-popup-hide').checked = h.topHide || false;
            document.getElementById('calc-exchanges').value = h.calcExchanges || "";
            renderExchanges();
        }

        window.renderExchanges = () => {
            const container = document.getElementById('exchange-list');
            container.innerHTML = '';
            (localConfig.exchanges || []).forEach((ex, i) => {
                const div = document.createElement('div');
                div.className = "p-4 glass-card border border-white/5 flex flex-col md:flex-row gap-4 items-center justify-between";
                div.innerHTML = `
                    <div class="flex items-center gap-4 w-full md:w-auto">
                        <img src="${ex.logo}" class="w-10 h-10 object-contain cursor-pointer" onclick="window.openAssetModal(${i})">
                        <input type="text" class="bg-transparent font-bold outline-none" value="${ex.name}" onchange="window.updateEx(${i}, 'name', this.value)">
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <input type="text" class="input-dark text-xs" value="${ex.link}" placeholder="링크" onchange="window.updateEx(${i}, 'link', this.value)">
                        <input type="number" class="input-dark text-xs w-20" value="${ex.rate}" placeholder="요율" onchange="window.updateEx(${i}, 'rate', this.value)">
                        <button onclick="window.deleteEx(${i})" class="text-red-400 px-2"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        };

        window.updateEx = (i, k, v) => localConfig.exchanges[i][k] = v;
        window.deleteEx = (i) => { localConfig.exchanges.splice(i, 1); renderExchanges(); };
        window.addExchangeRow = () => { localConfig.exchanges.push({ id: Date.now(), name: 'New', logo: 'https://via.placeholder.com/50', link: '', rate: 30 }); renderExchanges(); };
        window.openAssetModal = (i) => { currentEditingIndex = i; document.getElementById('asset-modal').style.display='flex'; };
        window.selectLogo = (url) => { if(currentEditingIndex > -1) { localConfig.exchanges[currentEditingIndex].logo = url; renderExchanges(); } document.getElementById('asset-modal').style.display='none'; };

        window.saveToFirebase = async () => {
            const btn = document.getElementById('save-btn');
            const loader = document.getElementById('save-loader');
            const saveText = document.getElementById('save-text');

            btn.disabled = true;
            loader.style.display = 'inline-block';
            saveText.innerText = "데이터 업로드 중...";

            localConfig.home = {
                noticeTitle: document.getElementById('notice-title').value,
                topText: document.getElementById('top-popup-text').value,
                topExchange: document.getElementById('top-popup-exchange').value,
                topAction: document.getElementById('top-popup-action').value,
                topHide: document.getElementById('top-popup-hide').checked,
                calcExchanges: document.getElementById('calc-exchanges').value
            };

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'configs', 'global');
                await setDoc(docRef, { ...localConfig, _updated: new Date().toISOString() });
                
                const toast = document.getElementById('toast');
                toast.className = 'show';
                setTimeout(() => toast.className = '', 3000);
            } catch (err) {
                alert("저장 오류: " + err.message);
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
                saveText.innerText = "클라우드 동기화 (홈페이지 즉시 반영)";
            }
        };

        init();
    </script>
</body>
</html>
