<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>리나닷컴 어드민 | 실시간 관리 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #0f111a;
            color: #e2e8f0;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }
        .input-field {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            width: 100%;
            outline: none;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        #toast {
            position: fixed; bottom: 30px; right: 30px;
            transform: translateY(150%); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
        }
        #toast.active { transform: translateY(0); }
    </style>
</head>
<body class="p-4 md:p-10 min-h-screen bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-slate-900 via-purple-900/20 to-slate-900">

    <div id="toast" class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-bold shadow-2xl flex items-center gap-3 border border-indigo-400">
        <i class="fas fa-check-circle text-xl"></i>
        <span>데이터가 성공적으로 동기화되었습니다!</span>
    </div>

    <div class="max-w-6xl mx-auto space-y-8">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div class="space-y-1">
                <h1 class="text-4xl font-black tracking-tighter italic text-white">LINA <span class="text-indigo-500">ADMIN</span></h1>
                <p class="text-slate-400 text-sm font-medium">실시간 데이터 관리 및 보안 통제</p>
            </div>
            
            <div id="status-card" class="glass-panel px-5 py-3 flex items-center gap-3">
                <div id="status-dot" class="status-dot bg-amber-500 animate-pulse"></div>
                <span id="status-text" class="text-xs font-black uppercase tracking-widest text-slate-400">연결 시도 중...</span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 space-y-8">
                <!-- 상단 공지 -->
                <div class="glass-panel p-8">
                    <div class="flex items-center gap-2 mb-6 text-indigo-400">
                        <i class="fas fa-bullhorn"></i>
                        <h2 class="text-xs font-black uppercase tracking-wider">상단 공지사항 바</h2>
                    </div>
                    <div class="space-y-5">
                        <input type="text" id="topText" class="input-field" placeholder="공지 텍스트를 입력하세요">
                        <label class="flex items-center gap-3 cursor-pointer group w-fit">
                            <input type="checkbox" id="topHide" class="w-5 h-5 rounded border-slate-700 bg-slate-800 checked:bg-indigo-600">
                            <span class="text-sm font-bold text-slate-400 group-hover:text-slate-200">공지 숨기기</span>
                        </label>
                    </div>
                </div>

                <!-- 거래소 관리 -->
                <div class="glass-panel p-8">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2 text-indigo-400">
                            <i class="fas fa-exchange-alt"></i>
                            <h2 class="text-xs font-black uppercase tracking-wider">제휴 거래소 관리</h2>
                        </div>
                        <button onclick="addExchange()" class="px-4 py-2 bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 border border-indigo-500/20 rounded-xl text-[10px] font-black transition-all">
                            + 거래소 추가
                        </button>
                    </div>
                    <div id="exchange-list" class="space-y-3">
                        <p class="text-center text-slate-500 py-10 italic">연결 중입니다...</p>
                    </div>
                </div>
            </div>

            <!-- 시스템 정보 및 저장 -->
            <div class="lg:col-span-4 space-y-8">
                <div class="glass-panel p-8">
                    <div class="flex items-center gap-2 mb-6 text-indigo-400">
                        <i class="fas fa-shield-alt"></i>
                        <h2 class="text-xs font-black uppercase tracking-wider">보안 및 상태</h2>
                    </div>
                    <div class="space-y-4 text-xs font-medium">
                        <div class="flex justify-between py-2 border-b border-white/5">
                            <span class="text-slate-500">인증 ID</span>
                            <span id="auth-uid" class="text-slate-300 italic">...</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-white/5">
                            <span class="text-slate-500">최근 동기화</span>
                            <span id="last-update" class="text-slate-300">없음</span>
                        </div>
                    </div>
                </div>

                <div class="sticky top-10">
                    <button id="save-btn" onclick="saveData()" class="w-full py-5 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white rounded-2xl font-black text-lg shadow-xl shadow-indigo-500/20 transition-all active:scale-95 disabled:opacity-50" disabled>
                        <i class="fas fa-save mr-2"></i>
                        실시간 저장하기
                    </button>
                    <p class="text-[10px] text-center text-slate-500 mt-4 leading-relaxed">
                        저장 즉시 홈페이지(index.html)에 반영됩니다.<br>
                        오류 시 파이어베이스 보안 규칙을 확인하세요.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. Firebase 설정 초기화
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'linapay-web';

        let localData = { exchanges: [], topText: "", topHide: false };

        // UI 상태 업데이트
        const setStatus = (type, text) => {
            const dot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const saveBtn = document.getElementById('save-btn');

            if (type === 'success') {
                dot.className = "status-dot bg-emerald-500";
                statusText.innerText = text || "정상 연결됨";
                statusText.className = "text-[10px] font-black uppercase text-emerald-500";
                saveBtn.disabled = false;
            } else if (type === 'error') {
                dot.className = "status-dot bg-rose-500";
                statusText.innerText = text || "연결 오류";
                statusText.className = "text-[10px] font-black uppercase text-rose-500";
                saveBtn.disabled = true;
            }
        };

        /**
         * 오류 수정: Firestore 경로는 짝수 세그먼트여야 합니다.
         * 규칙: /artifacts/{appId}/public/data/{documentId}
         * 이전: artifacts/appId/public/data/mainConfig (5개 - 오류)
         * 수정: artifacts, appId, public, data, mainConfig, default (6개 - 정상)
         */
        const getConfigDocRef = () => {
            return doc(db, 'artifacts', appId, 'public', 'data', 'mainConfig', 'default');
        };

        // 2. 인증 및 실시간 리스너 (RULE 3 준수)
        const init = async () => {
            try {
                // 인증 시도
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        document.getElementById('auth-uid').innerText = user.uid.substring(0, 10);
                        
                        const docRef = getConfigDocRef();
                        
                        onSnapshot(docRef, (snap) => {
                            if (snap.exists()) {
                                localData = snap.data();
                                if (!localData.exchanges) localData.exchanges = [];
                                syncUI(localData);
                                document.getElementById('last-update').innerText = new Date().toLocaleTimeString();
                                setStatus('success');
                            } else {
                                setStatus('success', '신규 데이터 생성 대기');
                                renderExchanges([]);
                            }
                        }, (err) => {
                            console.error("Firestore Error:", err);
                            setStatus('error', '권한 거부 (Rules 확인)');
                        });
                    }
                });
            } catch (err) {
                console.error("Auth Error:", err);
                setStatus('error', '인증 실패');
            }
        };

        function syncUI(data) {
            document.getElementById('topText').value = data.topText || "";
            document.getElementById('topHide').checked = data.topHide || false;
            renderExchanges(data.exchanges || []);
        }

        function renderExchanges(list) {
            const container = document.getElementById('exchange-list');
            if (!list || list.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-600 py-10 text-xs italic bg-slate-800/20 rounded-xl border border-dashed border-white/5">등록된 거래소가 없습니다. 우측 상단 '거래소 추가'를 클릭하세요.</div>`;
                return;
            }
            container.innerHTML = list.map((ex, i) => `
                <div class="flex items-center gap-4 p-4 bg-slate-800/50 rounded-xl border border-white/5 group transition-all hover:bg-slate-800">
                    <div class="flex-1 grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <span class="text-[9px] text-indigo-400 font-black uppercase ml-1">거래소 명칭</span>
                            <input type="text" value="${ex.name || ''}" oninput="updateEx(${i}, 'name', this.value)" class="input-field text-xs py-2" placeholder="예: Binance">
                        </div>
                        <div class="space-y-1">
                            <span class="text-[9px] text-indigo-400 font-black uppercase ml-1">페이백 요율 (%)</span>
                            <input type="number" value="${ex.rate || 0}" oninput="updateEx(${i}, 'rate', this.value)" class="input-field text-xs py-2" placeholder="0">
                        </div>
                    </div>
                    <button onclick="deleteEx(${i})" class="text-slate-600 hover:text-rose-500 transition-colors p-2 mt-4">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `).join('');
        }

        window.addExchange = () => {
            if (!localData.exchanges) localData.exchanges = [];
            localData.exchanges.push({ name: '', rate: 0 });
            renderExchanges(localData.exchanges);
        };

        window.updateEx = (i, k, v) => {
            localData.exchanges[i][k] = k === 'rate' ? parseFloat(v) || 0 : v;
        };

        window.deleteEx = (i) => {
            localData.exchanges.splice(i, 1);
            renderExchanges(localData.exchanges);
        };

        window.saveData = async () => {
            const saveBtn = document.getElementById('save-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<i class="fas fa-spinner animate-spin mr-2"></i> 데이터 업로드 중...`;

            try {
                if (!auth.currentUser) throw new Error("인증되지 않은 사용자입니다.");

                const docRef = getConfigDocRef();
                const payload = {
                    topText: document.getElementById('topText').value,
                    topHide: document.getElementById('topHide').checked,
                    exchanges: localData.exchanges || [],
                    lastSync: new Date().toISOString(),
                    updatedBy: auth.currentUser.uid
                };

                await setDoc(docRef, payload, { merge: true });
                
                document.getElementById('toast').classList.add('active');
                setTimeout(() => document.getElementById('toast').classList.remove('active'), 3000);
            } catch (err) {
                console.error("Save Error:", err);
                alert("저장 실패: " + (err.code === 'permission-denied' ? "파이어베이스 보안 규칙(Rules)을 확인하세요." : err.message));
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        };

        window.onload = init;
    </script>
</body>
</html>
